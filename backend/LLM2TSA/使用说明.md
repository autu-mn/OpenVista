# 模块1（LLM辅助增强器）使用说明

## 快速开始

### 1. 运行测试

```bash
cd backend
python -m LLM2TSA.test_enhancer
```

这会自动：
- 加载已有的时序数据（从 `DataProcessor/data/` 目录）
- 爬取文本时序数据（最近6个月）
- 执行完整的数据增强流程
- 保存结果到 `LLM2TSA/test_output/`

### 2. 在代码中使用

```python
from LLM2TSA.text_crawler import TextTimeSeriesCrawler
from LLM2TSA.enhancer import TimeSeriesEnhancer

# 1. 爬取文本时序数据
crawler = TextTimeSeriesCrawler()
time_axis = ["2020-08", "2020-09", "2020-10", ...]  # 从时序数据中提取
text_timeseries = crawler.crawl_text_timeseries("owner", "repo", time_axis)

# 2. 数据增强
enhancer = TimeSeriesEnhancer(use_cache=True)
result = enhancer.enhance_all(timeseries_data, text_timeseries)

# 3. 使用结果
print(result['summary'])  # 整体总结
print(result['trends'])   # 趋势列表
print(result['key_points'])  # 关键点列表
```

## 功能说明

### 1. 文本数据爬取（TextTimeSeriesCrawler）

**功能**：按月爬取最热门的Issue/PR/Commit

**方法**：
- `get_hottest_issue_in_month(owner, repo, month)` - 获取指定月份最热门的Issue
- `get_hottest_pr_in_month(owner, repo, month)` - 获取指定月份最热门的PR
- `get_hottest_commit_in_month(owner, repo, month)` - 获取指定月份最热门的Commit
- `crawl_text_timeseries(owner, repo, time_axis, progress_callback)` - 批量爬取

**热度计算**：
- Issue/PR: `评论数*0.4 + 点赞数*0.3 + 参与人数*0.3`
- Commit: `评论数 + 点赞数`

### 2. 数据增强（TimeSeriesEnhancer）

**功能**：为时序数据添加语义信息

**方法**：
- `enhance_month(month, metrics, text_data)` - 单月数据增强
- `detect_trends(timeseries_data, text_timeseries)` - 趋势识别
- `enhance_key_points(timeseries_data, text_timeseries)` - 关键点增强
- `extract_semantic_features(timeseries_data, text_timeseries)` - 语义特征提取
- `generate_summary(...)` - 整体总结
- `enhance_all(timeseries_data, text_timeseries)` - 完整增强流程

**支持的指标**：
- 所有 `data_service.py` 中定义的指标都会被处理
- 优先显示：OpenRank、活跃度、Star数、Fork数、参与者数、代码提交数、新增Issue、PR接受数
- 其他指标也会包含在增强描述中

## 输出数据结构

```json
{
  "time_axis": ["2020-08", "2020-09", ...],
  "monthly_data": {
    "2020-08": {
      "metrics": {...},
      "text_data": {
        "hottest_issue": {...},
        "hottest_pr": {...},
        "hottest_commit": {...}
      },
      "enhanced_description": "2020年8月..."
    }
  },
  "trends": [
    {
      "period": "2020-08 to 2020-12",
      "type": "上升",
      "metric": "OpenRank",
      "change_rate": 25.5,
      "description": "...",
      "key_events": [...]
    }
  ],
  "key_points": [
    {
      "date": "2020-12",
      "value": 12.65,
      "type": "峰值",
      "metric": "OpenRank",
      "explanation": "..."
    }
  ],
  "semantic_features": {
    "growth_rate": "高",
    "stability": "中",
    "text_activity": "高",
    "overall_status": "健康发展"
  },
  "summary": "整体总结..."
}
```

## 配置

### 环境变量

```bash
# .env 文件
GITHUB_TOKEN=your_github_token
DEEPSEEK_API_KEY=your_deepseek_key  # 用于LLM增强
```

### 缓存

增强结果会自动缓存到 `LLM2TSA/cache/` 目录，避免重复调用LLM。

禁用缓存：
```python
enhancer = TimeSeriesEnhancer(use_cache=False)
```

## 注意事项

1. **API限流**：GitHub API有速率限制，爬取大量数据时可能需要等待
2. **Token消耗**：LLM调用会消耗Token，建议启用缓存
3. **数据对齐**：确保时序数据和文本数据的时间轴对齐
4. **缺失数据**：如果某月没有Issue/PR/Commit，会返回 `null`

## 故障排查

### 1. LLM调用失败
- 检查 `DEEPSEEK_API_KEY` 是否正确配置
- 检查网络连接
- 查看错误日志

### 2. GitHub API限流
- 等待60秒后重试
- 使用多个Token轮换
- 减少爬取的数据量

### 3. 数据加载失败
- 检查 `DataProcessor/data/` 目录下是否有项目数据
- 确认项目名称格式正确（`owner/repo` 或 `owner_repo`）

## 示例输出

运行测试后，会在 `LLM2TSA/test_output/` 目录下生成增强结果JSON文件，可以查看完整的增强数据。

